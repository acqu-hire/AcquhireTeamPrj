<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aqh.board.domain.dao.QnAMapper">
	
	<select id="boardCount" resultType="int">
		SELECT count(*) 
		FROM board
		WHERE menu='QNA'
		<if test="category != null and !category.equals('')">
			AND category=#{category} 
		</if>
		<include refid="search" />
	</select>
	
	<update id="readCountUp" parameterType="long">
		UPDATE board 
		SET readCount=readCount+1
		WHERE bno=#{bno} AND menu='QNA'
	</update>
	
	<sql id="search">
		<choose>
			<when test="keyfield == 'title'">
				AND title LIKE CONCAT('%', #{keyword}, '%')
			</when>
			<when test="keyfield == 'id'">
				AND id LIKE CONCAT('%', #{keyword}, '%')
			</when>
			<when test="keyfield == 'contents'">
				AND contents LIKE CONCAT('%', #{keyword}, '%')
			</when>
			<when test="keyfield == 'title-contents'">
				AND (title LIKE CONCAT('%', #{keyword}, '%')
				OR contents LIKE CONCAT('%', #{keyword}, '%'))
			</when>
		</choose>
	</sql>
	
	<select id="selectAll" resultType="BoardDTO">
 		SELECT * FROM 
			(SELECT @rownum:=@rownum+1 AS rownum , bno, title, id, DATE_FORMAT(writeDay,'%Y-%m-%d') writeDay, readCount, category, replyCnt
			FROM board A, (SELECT @rownum:=0) R
			WHERE menu='QNA'
			<if test="category != null and !category.equals('')">
				AND category=#{category} 
			</if>
			<include refid="search" />
			ORDER BY writeDay DESC, bno DESC) B
		WHERE rownum between #{startRow} and #{endRow}
	</select>
	
	<select id="selectDetail" parameterType="long" resultType="BoardDTO">
		SELECT bno, title, contents, id, writeDay, readCount, category, replyCnt
		FROM board
		WHERE bno=#{bno} AND menu='QNA'
	</select>
	
	<insert id="insert" parameterType="BoardDTO" useGeneratedKeys="true" keyProperty="bno">
		INSERT INTO board(id, title, contents, menu, category)
		VALUES (#{id}, #{title}, #{contents}, 'QNA', #{category})
	</insert>
	
	<update id="update" parameterType="BoardDTO">
		UPDATE board
		SET title=#{title}, contents=#{contents}
		WHERE bno=#{bno} AND menu='QNA'
	</update>
	
	<delete id="deleteAll">
		DELETE FROM board
		WHERE menu='QNA'
	</delete>
	
	<delete id="delete" parameterType="long">
		DELETE FROM board
		WHERE bno=#{bno} AND menu='QNA'
	</delete>
	
	<select id="fileList" resultType="FileDTO">
		SELECT * FROM attachfile
		WHERE bno=#{bno}
	</select>
	
	<select id="getReplyCnt" resultType="long">
		SELECT replyCnt FROM board
		WHERE bno=#{bno}
	</select>
	
	<select id="getReadCnt" resultType="int">
		SELECT readCount FROM board
		WHERE bno=#{bno}
	</select>
</mapper>